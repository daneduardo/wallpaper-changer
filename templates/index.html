<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallpaper Changer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for the preview area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen flex items-center justify-center p-4 text-slate-200 font-sans antialiased">

    <div
        class="w-full max-w-5xl bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-slate-700/50 overflow-hidden flex flex-col md:flex-row">

        <!-- Config Section -->
        <div class="p-8 md:w-1/2 border-b md:border-b-0 md:border-r border-slate-700/50 relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>

            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
                    <span class="text-3xl">üñºÔ∏è</span> Wallpaper Changer
                </h1>
                <p class="text-slate-400 text-sm mt-2 font-medium">Panel de Control y Configuraci√≥n</p>
            </div>

            <form id="configForm" class="space-y-6">
                <div class="space-y-2">
                    <label for="intervalo" class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Intervalo
                        de Cambio</label>
                    <div class="relative">
                        <select id="intervalo" name="intervalo" required
                            class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all appearance-none cursor-pointer hover:bg-slate-900">
                            <option value="60">1 minuto</option>
                            <option value="600">10 minutos</option>
                            <option value="1800">30 minutos</option>
                            <option value="3600">1 hora</option>
                            <option value="21600">6 horas</option>
                            <option value="43200">12 horas</option>
                            <option value="86400">24 horas</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="carpeta_portrait"
                        class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Carpeta Vertical</label>
                    <input type="text" id="carpeta_portrait" name="carpeta_portrait" required
                        class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all text-sm placeholder-slate-500">
                    <div id="count-portrait" class="flex items-center gap-2 text-xs text-slate-400 font-medium pl-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> Cargando...
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="carpeta_normales"
                        class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Carpeta Horizontal</label>
                    <input type="text" id="carpeta_normales" name="carpeta_normales" required
                        class="w-full bg-slate-900/80 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all text-sm placeholder-slate-500">
                    <div id="count-normales" class="flex items-center gap-2 text-xs text-slate-400 font-medium pl-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> Cargando...
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button type="submit"
                        class="group bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2 active:scale-95">
                        <span>üíæ</span> Guardar
                    </button>
                    <button type="button" onclick="cambiarAhora()"
                        class="group bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200 shadow-lg shadow-emerald-500/20 flex items-center justify-center gap-2 active:scale-95">
                        <span class="group-hover:rotate-180 transition-transform duration-500">üîÑ</span> Cambiar
                    </button>
                </div>
            </form>

        </div>

        <!-- Preview Section -->
        <div class="p-8 md:w-1/2 bg-slate-900/30 flex flex-col">
            <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2 border-b border-slate-700/50 pb-4">
                <span class="text-purple-400">üñ•Ô∏è</span> Vista Previa Activa
            </h2>

            <div id="monitors-container" class="flex-1 space-y-6 overflow-y-auto custom-scrollbar pr-2">
                <div class="animate-pulse bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                    <div class="h-4 w-24 bg-slate-700 rounded mb-3"></div>
                    <div class="aspect-video bg-slate-700 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="status-toast"
        class="fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-500 z-50">
        <div
            class="bg-white dark:bg-slate-800 text-slate-800 dark:text-white px-6 py-4 rounded-xl shadow-2xl border-l-4 flex items-center gap-4 min-w-[320px]">
            <span id="toast-icon" class="text-2xl"></span>
            <p id="toast-message" class="font-medium text-sm"></p>
        </div>
    </div>

    <script>
        const configForm = document.getElementById('configForm');
        const statusToast = document.getElementById('status-toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');

        // Load config on page load
        window.addEventListener('DOMContentLoaded', () => {
            if (window.location.protocol === 'file:') {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-slate-900 text-white p-4 font-sans">
                        <div class="max-w-md text-center space-y-6">
                            <div class="text-6xl">‚ö†Ô∏è</div>
                            <h1 class="text-2xl font-bold text-red-400">Modo de ejecuci√≥n incorrecto</h1>
                            <p class="text-slate-300">Has abierto el archivo <code class="bg-slate-800 px-2 py-1 rounded text-sm">index.html</code> directamente.</p>
                            <div class="bg-slate-800 p-6 rounded-xl text-left text-sm space-y-3 border border-slate-700 shadow-xl">
                                <p class="font-bold text-indigo-400 uppercase tracking-wider text-xs">C√≥mo iniciar correctamente:</p>
                                <ol class="list-decimal list-inside space-y-2 text-slate-300">
                                    <li>Cierra esta pesta√±a.</li>
                                    <li>Ejecuta <code class="text-emerald-400 font-mono">python app.py</code> o el archivo <code class="text-emerald-400 font-mono">.bat</code>.</li>
                                    <li>Espera a que se abra el navegador autom√°ticamente en <code class="text-indigo-300">localhost:5000</code>.</li>
                                </ol>
                            </div>
                        </div>
                    </div>`;
                return;
            }
            cargarConfiguracion();
            actualizarPreview();
            // Auto-refresh preview every 5 seconds
            setInterval(actualizarPreview, 10000);
        });

        async function cargarConfiguracion() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('intervalo').value = config.intervalo;
                document.getElementById('carpeta_portrait').value = config.carpeta_portrait;
                document.getElementById('carpeta_normales').value = config.carpeta_normales;

                actualizarConteos();
            } catch (error) {
                mostrarError('Error cargando configuraci√≥n');
            }
        }

        async function actualizarConteos() {
            try {
                const portraitRes = await fetch('/api/imagenes/portrait');
                const portraitData = await portraitRes.json();
                document.getElementById('count-portrait').innerHTML =
                    `<span class="text-emerald-400">‚óè</span> ${portraitData.count} im√°genes encontradas`;


                const normalesRes = await fetch('/api/imagenes/normales');
                const normalesData = await normalesRes.json();
                document.getElementById('count-normales').innerHTML =
                    `<span class="text-emerald-400">‚óè</span> ${normalesData.count} im√°genes encontradas`;

            } catch (error) {
                console.error('Error actualizando conteos:', error);
            }
        }

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const config = {
                intervalo: parseInt(document.getElementById('intervalo').value),
                carpeta_portrait: document.getElementById('carpeta_portrait').value,
                carpeta_normales: document.getElementById('carpeta_normales').value
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    mostrarExito('‚úÖ Configuraci√≥n guardada correctamente');
                    actualizarConteos();
                } else {
                    mostrarError(result.message);
                }
            } catch (error) {
                mostrarError('Error guardando configuraci√≥n');
            }
        });

        async function actualizarPreview() {
            try {
                const response = await fetch('/api/current-wallpaper');
                const wallpapers = await response.json();

                // Get actual monitor count from the system and limit preview to that
                let monitorCount = Infinity;
                try {
                    const monRes = await fetch('/api/monitors');
                    const monData = await monRes.json();
                    monitorCount = monData.count || Infinity;
                } catch (e) {
                    console.warn('No se pudo obtener el conteo de monitores, mostrando todos los wallpapers disponibles');
                }
                const container = document.getElementById('monitors-container');

                if (Object.keys(wallpapers).length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-40 text-slate-500 bg-slate-800/30 rounded-xl border border-dashed border-slate-700">
                            <span class="text-2xl mb-2">üí§</span>
                            <span class="text-sm">No hay wallpaper activo</span>
                        </div>`;
                    return;
                }

                container.innerHTML = '';
                for (const [monitorId, path] of Object.entries(wallpapers)) {
                    // Filter out any reported wallpapers beyond the actual monitor count
                    if (Number(monitorId) > monitorCount) continue;
                    const monitorDiv = document.createElement('div');
                    monitorDiv.className = 'bg-slate-800 rounded-xl p-4 border border-slate-700 shadow-lg transition-transform hover:scale-[1.02] duration-300';


                    // Use the serve-image API to load the local file
                    const imageUrl = `/api/serve-image?path=${encodeURIComponent(path)}&t=${new Date().getTime()}`;
                    const fileName = path.split(/[\\/]/).pop();

                    monitorDiv.innerHTML = `
                         <div class="flex justify-between items-center mb-3">
                            <span class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Monitor ${monitorId}</span>
                            <span class="text-[10px] bg-slate-700 text-slate-300 px-2 py-1 rounded-full truncate max-w-[150px]">${fileName}</span>
                        </div>
                        <div class="aspect-video rounded-lg overflow-hidden bg-slate-900 border border-slate-700 relative group">
                            <img src="${imageUrl}" alt="Wallpaper Monitor ${monitorId}" class="w-full h-full object-cover transition-opacity duration-500">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                        </div>
                    `;
                    container.appendChild(monitorDiv);
                }
            } catch (error) {
                console.error("Error actualizando preview:", error);
            }
        }

        async function cambiarAhora() {
            try {
                const response = await fetch('/api/cambiar-ahora', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    mostrarExito('üîÑ Cambio de wallpaper iniciado');
                    setTimeout(actualizarPreview, 1000); // Refresh preview shortly after
                } else {
                    mostrarError(result.message);
                }
            } catch (error) {
                mostrarError('Error al cambiar wallpaper');
            }
        }

        function mostrarExito(mensaje) {
            showToast(mensaje, 'success');
        }

        function mostrarError(mensaje) {
            showToast(mensaje, 'error');
        }

        function showToast(message, type) {
            toastMessage.textContent = message;

            if (type === 'success') {
                statusToast.className = 'fixed bottom-6 right-6 transform translate-y-0 opacity-100 transition-all duration-500 z-50';
                statusToast.firstElementChild.className = 'bg-white dark:bg-slate-800 text-slate-800 dark:text-white px-6 py-4 rounded-xl shadow-2xl border-l-4 border-emerald-500 flex items-center gap-4 min-w-[320px]';
                toastIcon.textContent = '';
            } else {
                statusToast.className = 'fixed bottom-6 right-6 transform translate-y-0 opacity-100 transition-all duration-500 z-50';
                statusToast.firstElementChild.className = 'bg-white dark:bg-slate-800 text-slate-800 dark:text-white px-6 py-4 rounded-xl shadow-2xl border-l-4 border-red-500 flex items-center gap-4 min-w-[320px]';
                toastIcon.textContent = '‚ùå';
            }
            setTimeout(() => {
                statusToast.className = 'fixed bottom-6 right-6 transform translate-y-24 opacity-0 transition-all duration-500 z-50';
            }, 3000);
        }
    </script>
</body>

</html>